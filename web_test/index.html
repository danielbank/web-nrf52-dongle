<!DOCTYPE html>
<html>
    <body>
        <button id="connect_usb">CONNECT (USB)</button>
        <input id="msg_usb"><button id="send_usb">SEND (USB)</button><br>
        <button id="connect_ble">CONNECT (BLE)</button>
        <input id="msg_ble"><button id="send_ble">SEND (BLE)</button><br>
    </body>
    <script>
        // Web USB related
        const usb_devices = new Map();
        const textDecoder = new TextDecoder();
        const textEncoder = new TextEncoder('utf-8');

        const readFromDevice = (device) => {
            device.transferIn(3, 64).then(result => {
                console.log(`RX_USB[${device.serialNumber}]:`, textDecoder.decode(result.data));
                readFromDevice(device);
            }, error => {
                // disconnect USB device
                const deviceId = `${device.productId}:${device.serialNumber}`;
                usb_devices.delete(deviceId);
                console.log('disconnected', device);
            });
        };

        const writeToDevice = (device, str) => {
            console.log(`TX_USB[${device.serialNumber}]:`, str);
            const data = textEncoder.encode(str);
            device.transferOut(2, data);
        };

        const openUSBDevice = async (device) => {
            await device.open();
            await device.selectConfiguration(1);
            await device.claimInterface(0);

            console.log('connected', device);

            usb_devices.set(`${device.productId}:${device.serialNumber}`, device);
            
            readFromDevice(device); 
        };

        const initWebUSB = async () => {
            const connectUSBBtn = document.querySelector("#connect_usb");
            const sendUSBBtn = document.querySelector("#send_usb");
            const msgUSBInput = document.querySelector("#msg_usb");

            connectUSBBtn.addEventListener('click', async () => {
                const device = await navigator.usb.requestDevice({ filters: [{}]});
                openUSBDevice(device);
            });

            sendUSBBtn.addEventListener('click', async () => {
                for(let [key, device] of usb_devices) {
                    device.transferOut(2, new Uint8Array([0x01, 
                    Math.floor(256*Math.random()),
                    Math.floor(256*Math.random()),
                    Math.floor(256*Math.random())]));
                writeToDevice(device, msgUSBInput.value);
                }
            });

            // Auto-connect to all devices previously approved ('paired')
            const availableDevices = await navigator.usb.getDevices();
            availableDevices.forEach(device => {
                // if(device.vendorId === empiriKitUSBID.VID && device.productId === empiriKitUSBID.PID) {
                    openDevice(device);                
                // }
            });
        
            navigator.usb.addEventListener('connect', evt => openDevice(evt.device));
        };

        // Web Bluetooth related
        const ble_devices = new Map();
        let ble_cmd_characteristic = null;

        startHeartbeatNotifications = async (server) => {
            console.log(`Start listening for heartbeats on BLE[${server.device.id}]`);
            const service = await server.getPrimaryService('12345678-1234-5678-1234-56789abcdef0');
            console.log('service', service);
            const characteristic = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef1');
            console.log('characteristic', characteristic);
            characteristic.addEventListener('characteristicvaluechanged', (evt) => {
                const value = evt.target.value.getInt16(0, true);
                console.log(`RX_BLE[${server.device.id}]: Heartbeat count = ${value}`);
            });
            return characteristic.startNotifications();
        }

        startDataNotifications = async (server) => {
            console.log(`Start listening for data on BLE[${device.id}]`);
            const service = await server.getPrimaryService('12345678-1234-5678-1234-56789abcdef0');
            const characteristic = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef2');
            characteristic.addEventListener('characteristicvaluechanged', (evt) => {
                const value = evt.target.value.getInt16(0, true);
                console.log(`RX_BLE[${device.id}]: Heartbeat count = ${value}`);
            });
            return characteristic.startNotifications();
        }

        fetchCmdCharacteristic = async (server) => {
            console.log(`Initialize cmd characteristic for BLE[${server.device.id}]`);
            const service = await server.getPrimaryService('12345678-1234-5678-1234-56789abcdef0');
            server.device.cmdCharacteristic = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef3');
        }


        const openBLEDevice = async (device) => {
            const server = await device.gatt.connect();
            
            window.bleserver = server;

            console.log(server);

            // try {
            //     await startHeartbeatNotifications(server);
            //     await startDataNotifications(server);
            //     await fetchCmdCharacteristic(server);
            //     console.log('connected', device);

            //     ble_devices.set(`${device.id}`, device);
            // } catch (err) {
            //     console.warn(err);
            // }
        };

        const initWebBluetooth = async () => {
            const connectBLEBtn = document.querySelector("#connect_ble");
            const sendBLEBtn = document.querySelector("#send_ble");
            const msgBLEInput = document.querySelector("#msg_ble");

            connectBLEBtn.addEventListener('click', async () => {
                // TODO actual UUID (if you want to build a device)!!
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['12345678-1234-5678-1234-56789abcdef0'] }]
                });

                console.log(device);

                await openBLEDevice(device);
            });

            sendBLEBtn.addEventListener('click', async () => {
                for(let [key, device] of ble_devices) {
                    // make receiver in firmware...
                }
            });

        };

        window.addEventListener('load', async () => {
            initWebUSB();
            initWebBluetooth();
        });

    </script>
</html>